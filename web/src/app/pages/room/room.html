<div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-6xl">
  <!-- Players -->
  @if (room) {
    <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4 mb-4">
      @for (player of room.players; track player.id) {
        <app-player-card [player]="player"></app-player-card>
      }
    </div>
  }

  @if (room.state == "lobby") {
    <div class="bg-gray-800 p-4 rounded-lg">
      <h2 class="text-white text-lg font-medium mb-2">
        Lobby - Room Code ({{ room.code }})
      </h2>
      <p class="text-gray-400">Waiting for players to join...</p>
    </div>

    @if (room.owner == playerId) {
      <div class="mt-4">
        <button
          class="w-full bg-primary hover:bg-primary-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-black py-3 px-4 rounded-lg font-medium disabled:text-white transition-colors"
          [disabled]="room.players.length < 2"
          (click)="onGameStart()"
        >
          Start Game
        </button>
      </div>
    }
  }

  @if (room.state == "finished") {
    <div class="bg-gray-800 p-6 rounded-lg">
      <div class="text-center mb-6">
        <h2 class="text-white text-2xl font-bold mb-2">üéâ Game Finished! üéâ</h2>
        @if (gameEndData && gameEndData.winner) {
          <p class="text-primary text-lg font-medium">
            Winner: {{ gameEndData.winner.playerName }} ({{
              gameEndData.winner.correctAnswers
            }}/{{ gameEndData.winner.totalRounds }} correct)
          </p>
        }
      </div>

      @if (gameEndData) {
        <!-- Final Scores -->
        <div class="mb-6">
          <h3 class="text-white text-lg font-medium mb-4 flex items-center">
            <span class="mr-2">üèÜ</span>
            Final Scores
          </h3>
          <div class="space-y-3">
            @for (
              score of gameEndData.scores;
              track score.playerId;
              let i = $index
            ) {
              <div
                class="flex items-center justify-between p-4 rounded-lg border"
                [class.bg-yellow-50]="i === 0"
                [class.border-yellow-200]="i === 0"
                [class.bg-gray-50]="i !== 0"
                [class.border-gray-200]="i !== 0"
              >
                <div class="flex items-center space-x-3">
                  <div
                    class="flex items-center justify-center w-8 h-8 rounded-full font-bold text-sm"
                    [class.bg-yellow-500]="i === 0"
                    [class.text-white]="i === 0"
                    [class.bg-gray-300]="i !== 0"
                    [class.text-gray-700]="i !== 0"
                  >
                    {{ i + 1 }}
                  </div>
                  <span class="font-medium text-gray-800">{{
                    score.playerName
                  }}</span>
                  @if (i === 0) {
                    <span class="text-yellow-600">üëë</span>
                  }
                </div>
                <div class="text-right">
                  <div
                    class="font-bold text-lg"
                    [class.text-yellow-600]="i === 0"
                    [class.text-gray-800]="i !== 0"
                  >
                    {{ score.correctAnswers }}/{{ score.totalRounds }}
                  </div>
                  <div class="text-xs text-gray-500">
                    {{
                      (score.correctAnswers / score.totalRounds) * 100
                        | number: "1.0-0"
                    }}%
                  </div>
                </div>
              </div>
            }
          </div>
        </div>

        <!-- Secret Characters Revealed -->
        <div>
          <h3 class="text-white text-lg font-medium mb-4 flex items-center">
            <span class="mr-2">üé≠</span>
            Secret Characters
          </h3>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
            @for (
              character of gameEndData.secretCharacters;
              track character.round
            ) {
              <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                <div class="text-center">
                  <div class="mb-3">
                    @if (character.imageUrl) {
                      <img
                        [src]="character.imageUrl"
                        [alt]="character.name"
                        class="w-20 h-20 mx-auto rounded-lg object-cover border border-gray-300"
                        (error)="onImageError($event)"
                      />
                    } @else {
                      <div
                        class="w-20 h-20 mx-auto rounded-lg bg-gray-300 flex items-center justify-center border border-gray-300"
                      >
                        <span class="text-gray-500 text-xs">No Image</span>
                      </div>
                    }
                  </div>
                  <div class="text-sm font-medium text-gray-800">
                    {{ character.name }}
                  </div>
                  <div class="text-xs text-gray-500 mt-1">
                    Round {{ character.round }}
                  </div>
                </div>
              </div>
            }
          </div>
        </div>

        <!-- Play Again Button -->
        <div class="mt-6 text-center">
          <button
            class="bg-primary hover:bg-primary-700 text-black px-6 py-3 rounded-lg font-medium transition-colors"
            (click)="goBackToHome()"
          >
            Play Again
          </button>
        </div>
      }
    </div>
  }

  @if (room.state == "in_progress") {
    <div class="bg-gray-800 p-4 rounded-lg mb-4">
      <h2 class="text-white text-lg font-medium mb-2">Game in Progress</h2>
      <div class="flex justify-between items-center mb-3">
        <p class="text-gray-400">
          Current round: {{ currentRound }}/{{ room.rounds }}
        </p>
        <div class="text-sm text-gray-400 flex items-center space-x-2">
          <span>Round Timer:</span>
          <div
            class="px-2 py-1 rounded font-mono font-medium"
            [class.text-red-400]="currentTimer <= 10 && isTimerActive"
            [class.text-yellow-400]="
              currentTimer > 10 && currentTimer <= 30 && isTimerActive
            "
            [class.text-green-400]="currentTimer > 30 && isTimerActive"
            [class.text-gray-400]="!isTimerActive"
            [class.bg-red-900]="currentTimer <= 10 && isTimerActive"
            [class.bg-yellow-900]="
              currentTimer > 10 && currentTimer <= 30 && isTimerActive
            "
            [class.bg-green-900]="currentTimer > 30 && isTimerActive"
            [class.animate-pulse]="currentTimer <= 10 && isTimerActive"
          >
            @if (isTimerActive) {
              {{ currentTimer }}s
            } @else {
              {{ room.roundTimer }}s
            }
          </div>
        </div>
      </div>

      <!-- Timer Progress Bar -->
      @if (isTimerActive && room.roundTimer) {
        <div class="w-full bg-gray-700 rounded-full h-2">
          <div
            class="h-2 rounded-full transition-all duration-1000 ease-linear"
            [class.bg-green-500]="currentTimer > room.roundTimer * 0.6"
            [class.bg-yellow-500]="
              currentTimer <= room.roundTimer * 0.6 &&
              currentTimer > room.roundTimer * 0.3
            "
            [class.bg-red-500]="currentTimer <= room.roundTimer * 0.3"
            [style.width.%]="(currentTimer / room.roundTimer) * 100"
          ></div>
        </div>
      }
    </div>

    <!-- Character Guess Input -->
    <div class="bg-gray-800 p-4 rounded-lg">
      <h3 class="text-white text-md font-medium mb-3">Guess the Character</h3>

      <div class="autocomplete-container">
        <input
          type="text"
          [(ngModel)]="guessInput"
          (input)="onGuessInputChange()"
          (keydown)="onKeyDown($event)"
          placeholder="Type a character name..."
          class="w-full px-3 py-2 bg-gray-700 text-white border rounded-lg focus:outline-none focus:ring-1 transition-colors"
          [class.border-gray-600]="!selectedCharacterId"
          [class.border-green-500]="selectedCharacterId"
          [class.focus:border-primary]="!selectedCharacterId"
          [class.focus:ring-primary]="!selectedCharacterId"
          [class.focus:border-green-400]="selectedCharacterId"
          [class.focus:ring-green-400]="selectedCharacterId"
          autocomplete="off"
        />

        <!-- Autocomplete Suggestions -->
        @if (showSuggestions) {
          <div class="suggestions-dropdown">
            @for (
              character of filteredCharacters;
              track character.id;
              let i = $index
            ) {
              <div
                class="suggestion-item"
                [class.bg-gray-600]="selectedSuggestionIndex === i"
                (click)="selectCharacter(character)"
              >
                {{ character.name }}
              </div>
            }
          </div>
        }
      </div>

      <button
        (click)="submitGuess()"
        [disabled]="!guessInput.trim() || isSubmittingGuess"
        class="mt-3 w-full py-2 px-4 rounded-lg font-medium transition-colors"
        [class.bg-primary]="selectedCharacterId && !isSubmittingGuess"
        [class.hover:bg-primary-700]="selectedCharacterId && !isSubmittingGuess"
        [class.text-black]="selectedCharacterId && !isSubmittingGuess"
        [class.bg-yellow-600]="
          !selectedCharacterId && guessInput.trim() && !isSubmittingGuess
        "
        [class.hover:bg-yellow-700]="
          !selectedCharacterId && guessInput.trim() && !isSubmittingGuess
        "
        [class.text-white]="
          !selectedCharacterId && guessInput.trim() && !isSubmittingGuess
        "
        [class.bg-gray-600]="!guessInput.trim() || isSubmittingGuess"
        [class.cursor-not-allowed]="!guessInput.trim() || isSubmittingGuess"
        [class.text-white]="!guessInput.trim() || isSubmittingGuess"
      >
        @if (isSubmittingGuess) {
          Submitting...
        } @else if (!guessInput.trim()) {
          Submit Guess
        } @else if (selectedCharacterId) {
          Submit Guess ‚úì
        } @else {
          Submit Guess (Not in list)
        }
      </button>

      <!-- Correct notice -->
      @if (isCorrect) {
        <div class="mt-2 text-green-500">
          Correct! üéâ
          @if (currentRound < room.rounds) {
            Next round starts in 5 seconds...
          }
        </div>
      }

      <!-- Guess History -->
      @if (guessHistory.length > 0) {
        <div class="mt-4">
          <h4 class="text-white text-sm font-medium mb-3 flex items-center">
            <span class="mr-2">üìù</span>
            Your Guesses ({{ guessHistory.length }})
          </h4>
          <div class="space-y-3 overflow-y-auto pr-2">
            @for (
              guess of guessHistory;
              track guess.timestamp;
              let i = $index
            ) {
              <div
                class="p-3 rounded-lg border shadow-sm"
                [class.bg-green-50]="guess.isCorrect"
                [class.border-green-200]="guess.isCorrect"
                [class.bg-gray-50]="!guess.isCorrect"
                [class.border-gray-200]="!guess.isCorrect"
              >
                <div class="flex space-x-3">
                  <!-- Character Image -->
                  <div class="flex-shrink-0">
                    @if (guess.characterImage) {
                      <img
                        [src]="guess.characterImage"
                        [alt]="guess.characterName"
                        class="w-16 h-16 rounded-lg object-cover border border-gray-300"
                        (error)="onImageError($event)"
                      />
                    } @else {
                      <div
                        class="w-16 h-16 rounded-lg bg-gray-300 flex items-center justify-center border border-gray-300"
                      >
                        <span class="text-gray-500 text-xs">No Image</span>
                      </div>
                    }
                  </div>

                  <!-- Content Area -->
                  <div class="flex-1 min-w-0">
                    <!-- Character Name and Overall Result -->
                    <div class="flex items-center justify-between mb-3">
                      <div class="flex items-center space-x-2">
                        <span
                          class="text-xs bg-gray-200 text-gray-600 px-2 py-1 rounded-full font-mono"
                        >
                          #{{ guessHistory.length - i }}
                        </span>
                        <span
                          class="font-medium text-sm"
                          [class.text-green-800]="guess.isCorrect"
                          [class.text-gray-800]="!guess.isCorrect"
                        >
                          {{ guess.characterName }}
                        </span>
                        @if (guess.isCorrect) {
                          <span class="text-green-600 text-lg">üéâ</span>
                        } @else {
                          <span class="text-red-600">‚ùå</span>
                        }
                      </div>
                      <span class="text-xs text-gray-500">
                        {{ guess.timestamp | date: "HH:mm:ss" }}
                      </span>
                    </div>

                    <!-- Attribute Comparison Grid -->
                    @if (guess.attributeEvaluation) {
                      <div
                        class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2"
                      >
                        @for (
                          item of getAttributeEvaluationEntries(
                            guess.attributeEvaluation
                          );
                          track item.key
                        ) {
                          <div
                            class="flex items-center justify-between p-2 rounded text-xs font-medium border"
                            [class.bg-green-100]="
                              item.value.status === 'correct'
                            "
                            [class.text-green-800]="
                              item.value.status === 'correct'
                            "
                            [class.border-green-200]="
                              item.value.status === 'correct'
                            "
                            [class.bg-yellow-100]="
                              item.value.status === 'partial'
                            "
                            [class.text-yellow-800]="
                              item.value.status === 'partial'
                            "
                            [class.border-yellow-200]="
                              item.value.status === 'partial'
                            "
                            [class.bg-red-100]="
                              item.value.status === 'incorrect'
                            "
                            [class.text-red-800]="
                              item.value.status === 'incorrect'
                            "
                            [class.border-red-200]="
                              item.value.status === 'incorrect'
                            "
                            [class.bg-blue-100]="
                              item.value.status === 'higher' ||
                              item.value.status === 'lower'
                            "
                            [class.text-blue-800]="
                              item.value.status === 'higher' ||
                              item.value.status === 'lower'
                            "
                            [class.border-blue-200]="
                              item.value.status === 'higher' ||
                              item.value.status === 'lower'
                            "
                          >
                            <span class="truncate font-semibold">{{
                              getAttributeDisplayName(item.key)
                            }}</span>
                            <div class="flex items-center space-x-1 ml-2">
                              <span class="max-w-20">{{
                                item.value.value.replaceAll(",", " ")
                              }}</span>
                              @if (item.value.status === "correct") {
                                <span class="text-green-600">‚úì</span>
                              } @else if (item.value.status === "partial") {
                                <span class="text-yellow-600">~</span>
                              } @else if (item.value.status === "higher") {
                                <span class="text-blue-600 font-bold">‚Üì</span>
                              } @else if (item.value.status === "lower") {
                                <span class="text-blue-600 font-bold">‚Üë</span>
                              } @else {
                                <span class="text-red-600">‚úó</span>
                              }
                            </div>
                          </div>
                        }
                      </div>
                    }
                  </div>
                </div>
              </div>
            }
          </div>
        </div>
      }
    </div>
  }
</div>
