<div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-6xl">
  <!-- Players -->
  @if (room) {
    <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4 mb-4">
      @for (player of room.players; track player.id) {
        <app-player-card [player]="player"></app-player-card>
      }
    </div>
  }

  @if (room.state == "lobby") {
    <div class="bg-gray-800 p-4 rounded-lg">
      <h2 class="text-white text-lg font-medium mb-2">
        Lobby - Room Code ({{ room.code }})
      </h2>
      <p class="text-gray-400">Waiting for players to join...</p>
    </div>

    @if (room.owner == playerId) {
      <div class="mt-4">
        <button
          class="w-full bg-primary hover:bg-primary-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-black py-3 px-4 rounded-lg font-medium disabled:text-white transition-colors"
          [disabled]="room.players.length < 2"
          (click)="onGameStart()"
        >
          Start Game
        </button>
      </div>
    }
  }

  @if (room.state == "in_progress") {
    <div class="bg-gray-800 p-4 rounded-lg mb-4">
      <h2 class="text-white text-lg font-medium mb-2">Game in Progress</h2>
      <div class="flex justify-between items-center">
        <p class="text-gray-400">
          Current round: {{ currentRound }}/{{ room.rounds }}
        </p>
        <div class="text-sm text-gray-400">
          Round Timer: {{ room.roundTimer }}s
        </div>
      </div>
    </div>

    <!-- Character Guess Input -->
    <div class="bg-gray-800 p-4 rounded-lg">
      <h3 class="text-white text-md font-medium mb-3">Guess the Character</h3>

      <div class="autocomplete-container">
        <input
          type="text"
          [(ngModel)]="guessInput"
          (input)="onGuessInputChange()"
          (keydown)="onKeyDown($event)"
          placeholder="Type a character name..."
          class="w-full px-3 py-2 bg-gray-700 text-white border rounded-lg focus:outline-none focus:ring-1 transition-colors"
          [class.border-gray-600]="!selectedCharacterId"
          [class.border-green-500]="selectedCharacterId"
          [class.focus:border-primary]="!selectedCharacterId"
          [class.focus:ring-primary]="!selectedCharacterId"
          [class.focus:border-green-400]="selectedCharacterId"
          [class.focus:ring-green-400]="selectedCharacterId"
          autocomplete="off"
        />

        <!-- Autocomplete Suggestions -->
        @if (showSuggestions) {
          <div class="suggestions-dropdown">
            @for (
              character of filteredCharacters;
              track character.id;
              let i = $index
            ) {
              <div
                class="suggestion-item"
                [class.bg-gray-600]="selectedSuggestionIndex === i"
                (click)="selectCharacter(character)"
              >
                {{ character.name }}
              </div>
            }
          </div>
        }
      </div>

      <button
        (click)="submitGuess()"
        [disabled]="!guessInput.trim() || isSubmittingGuess"
        class="mt-3 w-full py-2 px-4 rounded-lg font-medium transition-colors"
        [class.bg-primary]="selectedCharacterId && !isSubmittingGuess"
        [class.hover:bg-primary-700]="selectedCharacterId && !isSubmittingGuess"
        [class.text-black]="selectedCharacterId && !isSubmittingGuess"
        [class.bg-yellow-600]="
          !selectedCharacterId && guessInput.trim() && !isSubmittingGuess
        "
        [class.hover:bg-yellow-700]="
          !selectedCharacterId && guessInput.trim() && !isSubmittingGuess
        "
        [class.text-white]="
          !selectedCharacterId && guessInput.trim() && !isSubmittingGuess
        "
        [class.bg-gray-600]="!guessInput.trim() || isSubmittingGuess"
        [class.cursor-not-allowed]="!guessInput.trim() || isSubmittingGuess"
        [class.text-white]="!guessInput.trim() || isSubmittingGuess"
      >
        @if (isSubmittingGuess) {
          Submitting...
        } @else if (!guessInput.trim()) {
          Submit Guess
        } @else if (selectedCharacterId) {
          Submit Guess ✓
        } @else {
          Submit Guess (Not in list)
        }
      </button>

      <!-- Guess Result Feedback -->
      @if (lastGuessResult) {
        <div
          class="mt-3 p-3 rounded-lg font-medium"
          [class.bg-green-100]="lastGuessResult.isCorrect"
          [class.text-green-800]="lastGuessResult.isCorrect"
          [class.bg-red-100]="!lastGuessResult.isCorrect"
          [class.text-red-800]="!lastGuessResult.isCorrect"
        >
          <div class="text-center mb-2">
            @if (lastGuessResult.isCorrect) {
              ✅ Correct! {{ lastGuessResult.characterName }} was the right
              answer!
            } @else {
              ❌ Incorrect: {{ lastGuessResult.characterName }}
            }
          </div>

          <!-- Attribute Evaluation Details -->
          @if (
            lastGuessResult.attributeEvaluation && !lastGuessResult.isCorrect
          ) {
            <div class="mt-3 text-sm">
              <div class="font-medium mb-2">Attribute Comparison:</div>
              <div class="space-y-1">
                @for (
                  item of getAttributeEvaluationEntries(
                    lastGuessResult.attributeEvaluation
                  );
                  track item.key
                ) {
                  <div
                    class="flex justify-between items-center text-xs p-2 rounded"
                    [class.bg-green-200]="item.value.status === 'correct'"
                    [class.text-green-800]="item.value.status === 'correct'"
                    [class.bg-yellow-200]="item.value.status === 'partial'"
                    [class.text-yellow-800]="item.value.status === 'partial'"
                    [class.bg-red-200]="item.value.status === 'incorrect'"
                    [class.text-red-800]="item.value.status === 'incorrect'"
                    [class.bg-blue-200]="
                      item.value.status === 'higher' ||
                      item.value.status === 'lower'
                    "
                    [class.text-blue-800]="
                      item.value.status === 'higher' ||
                      item.value.status === 'lower'
                    "
                  >
                    <span class="font-medium capitalize">{{ item.key }}:</span>
                    <span>
                      {{ item.value.value }}
                      @if (item.value.status === "correct") {
                        ✓
                      } @else if (item.value.status === "partial") {
                        ~
                      } @else if (item.value.status === "higher") {
                        ↑
                      } @else if (item.value.status === "lower") {
                        ↓
                      } @else {
                        ✗
                      }
                    </span>
                  </div>
                }
              </div>
            </div>
          }
        </div>
      }
    </div>
  }
</div>
